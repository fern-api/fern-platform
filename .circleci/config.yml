version: 2.1
orbs:
  node: circleci/node@5.0.1
  aws-cli: circleci/aws-cli@3.1.1
jobs:
  check:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn-berry
      - run:
          name: lint:monorepo
          command: yarn lint:monorepo
      - run:
          name: Check root package
          command: yarn root-package:check
      - run:
          name: Check dependencies
          command: yarn depcheck
      - run:
          name: lint:style
          command: yarn lint:style
      - run:
          name: Format
          command: yarn format:check
      - run:
          name: Ensure no changes to git-tracked files
          command: git --no-pager diff --exit-code

  organize-imports:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn-berry
      - run:
          name: Organize imports
          # not using --list-different because sometimes this removes a trailing
          # comma that prettier adds back
          command: yarn organize-imports
      - run:
          name: Format
          command: yarn format:fix
      - run:
          name: Ensure no changes to git-tracked files
          command: git --no-pager diff --exit-code

  eslint:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn-berry
      - run:
          # compilation is needed for some typescript-eslint rules
          name: compile
          command: yarn compile
      - run:
          name: lint:eslint
          command: yarn lint:eslint

  compile:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn-berry
      - run:
          name: compile
          command: yarn compile

  test:
    # this is machine because of the docker-utils tests
    machine:
      image: ubuntu-2004:current
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn-berry
      - run:
          name: Run tests
          command: yarn test --ci
      - run:
          name: Ensure no changes to git-tracked files
          command: git --no-pager diff --exit-code

  check-docs-release-is-allowed:
    machine:
      image: ubuntu-2004:current
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn-berry
      - run:
          name: Check release blockers
          command: yarn check-docs-release-blockers

  deploy-docs-prod:
    docker:
      - image: cimg/node:lts
    resource_class: large
    steps:
      - checkout
      - run:
          name: Install vercel
          command: sudo npm install --global vercel@latest
      - run:
          name: Pull Vercel environment information
          command: vercel pull --yes --environment=production --token=${VERCEL_TOKEN}
      - run:
          name: Build project artifacts
          command: vercel build --prod --token=${VERCEL_TOKEN}
      - run:
          name: Deploy
          command: vercel deploy --prebuilt --prod --token=${VERCEL_TOKEN}

  dryrun-deploy-local-preview-dev2:
    docker:
      - image: cimg/node:18.18.2
    resource_class: large
    steps:
      - checkout
      - aws-cli/setup
      - run: yarn install
      - run:
          name: Build local preview bundle
          command: yarn workspace @fern-ui/local-preview-bundle run build
      - run: npm install -g aws-cdk
      - run:
          name: Synthesize local preview bundle
          command: yarn workspace @fern-ui/cdk run synth:dev2

  deploy-local-preview-dev2:
    docker:
      - image: cimg/node:18.18.2
    resource_class: large
    steps:
      - checkout
      - aws-cli/setup
      - run: yarn install
      - run:
          name: Build local preview bundle
          command: yarn workspace @fern-ui/local-preview-bundle run build
      - run: npm install -g aws-cdk
      - run:
          name: Deploy local preview bundle
          command: yarn workspace @fern-ui/cdk run deploy:dev2

  deploy-local-preview-prod:
    docker:
      - image: cimg/node:18.18.2
    resource_class: large
    steps:
      - checkout
      - aws-cli/setup
      - run: yarn install
      - run:
          name: Build local preview bundle
          command: yarn workspace @fern-ui/local-preview-bundle run build
      - run: npm install -g aws-cdk
      - run:
          name: Deploy local preview bundle
          command: yarn workspace @fern-ui/cdk run deploy:prod

  generate-customer-docs:
    docker:
      - image: cimg/node:lts
    parameters:
      docs_path:
        type: string
    steps:
      - checkout
      - run:
          name: Download fern-dev CLI
          command: |
            npm config set //registry.npmjs.org/:_authToken $YARN_NPM_AUTH_TOKEN
            npm install -g @fern-api/fern-api-dev --prefix=$HOME/.local
      - run:
          name: Generate Customer Docs
          command: |
            echo 'export FERN_TOKEN="$FERN_ORG_TOKEN_DEV"' >> $BASH_ENV
            source "$BASH_ENV"
            cd << parameters.docs_path >>
            fern-dev generate --docs --log-level debug
            echo "Generated docs for customer!"

workflows:
  build:
    jobs:
      - check:
          context:
            - npm
          filters:
            tags:
              only: /.*/

      - eslint:
          context:
            - npm
          filters:
            tags:
              only: /.*/

      - organize-imports:
          context:
            - npm
          filters:
            tags:
              only: /.*/

      - compile:
          context:
            - npm
          filters:
            tags:
              only: /.*/

      - test:
          context:
            - npm
          filters:
            tags:
              only: /.*/

      - deploy-docs-prod:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^([0-9]+)\.([0-9]+)\.([0-9]+)$/
          requires:
            - check-docs-release-is-allowed
            - check
            - organize-imports
            - compile
            - eslint
            - test
          context:
            - vercel-prod
            - fe-algolia-prod

      - dryrun-deploy-local-preview-dev2:
          context:
            - aws
            - github

      - deploy-local-preview-dev2:
          filters:
            branches:
              only:
                - main
            tags:
              ignore: /.*/
          requires:
            - check
            - organize-imports
            - compile
            - eslint
            - test
            - dryrun-deploy-local-preview-dev2
          context:
            - aws
            - github

      - deploy-local-preview-prod:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^([0-9]+)\.([0-9]+)\.([0-9]+)$/
          requires:
            - dryrun-deploy-local-preview-dev2
            - deploy-docs-prod
          context:
            - aws
            - github

      - check-docs-release-is-allowed:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^([0-9]+)\.([0-9]+)\.([0-9]+)$/
          context:
            - npm

  preview-customer-docs:
    jobs:
      - generate-customer-docs:
          name: preview-docs-candid
          docs_path: tests/candid
          context:
            - fern-tokens
            - npm
          filters:
            branches:
              only:
                - main
      - generate-customer-docs:
          name: preview-docs-fern
          docs_path: tests/fern
          context:
            - fern-tokens
            - npm
          filters:
            branches:
              only:
                - main
      - generate-customer-docs:
          name: preview-docs-flatfile
          docs_path: tests/flatfile
          context:
            - fern-tokens
            - npm
          filters:
            branches:
              only:
                - main
      - generate-customer-docs:
          name: preview-docs-mercoa
          docs_path: tests/mercoa
          context:
            - fern-tokens
            - npm
          filters:
            branches:
              only:
                - main
      - generate-customer-docs:
          name: preview-docs-primer
          docs_path: tests/primer
          context:
            - fern-tokens
            - npm
          filters:
            branches:
              only:
                - main
      - generate-customer-docs:
          name: preview-docs-superagent
          docs_path: tests/superagent
          context:
            - fern-tokens
            - npm
          filters:
            branches:
              only:
                - main
      - generate-customer-docs:
          name: preview-docs-vellum
          docs_path: tests/vellum
          context:
            - fern-tokens
            - npm
          filters:
            branches:
              only:
                - main
