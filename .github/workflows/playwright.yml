name: Playwright Tests
on: pull_request

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: "buildwithfern"
  FERN_TOKEN: ${{ secrets.FERN_TOKEN }}
  WORKOS_API_KEY: ${{ secrets.WORKOS_API_KEY }}
  WORKOS_CLIENT_ID: ${{ secrets.WORKOS_CLIENT_ID }}
  # HUME_API_KEY: ${{ secrets.HUME_API_KEY }}

jobs:
  test:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions: write-all # required for the playwright-report-summary action
    steps:
      - uses: actions/checkout@v4

      - name: Install
        uses: ./.github/actions/install

      - name: Compile and build
        run: pnpm turbo compile codegen build
        env:
          FERN_TOKEN: ${{ secrets.FERN_TOKEN }}
          WORKOS_API_KEY: ${{ secrets.WORKOS_API_KEY }}
          WORKOS_CLIENT_ID: ${{ secrets.WORKOS_CLIENT_ID }}

      - name: Build next bundle
        run: cd packages/ui/local-preview-bundle; pnpm turbo build

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps

      - name: Install fern-dev API
        env:
          NPM_TOKEN: ${{ secrets.FERN_NPM_TOKEN }}
          FERN_TOKEN: ${{ secrets.FERN_ORG_TOKEN_DEV }}
        run: |
          npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
          npm install -g @fern-api/fern-api-dev

      - name: Run Playwright tests
        run: PLAYWRIGHT_JSON_OUTPUT_NAME=results.json pnpm exec playwright test playwright/fixtures --reporter json

      - uses: daun/playwright-report-summary@v3
        if: always()
        with:
          report-file: results.json
