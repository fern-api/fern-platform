name: CI

# Controls when the workflow will run
on:
  push:
    branches:
      - "**"

jobs:
  # Jobs go here
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Compile
        run: yarn compile

      - name: Check dependencies
        run: yarn depcheck

      - name: Check format
        run: yarn format:check

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint monorepo
        run: yarn lint:monorepo

      - name: Lint style
        run: yarn lint:style

      - name: Lint typescript
        run: yarn lint:eslint

  organize-imports:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Organize imports
        # not using --list-different because sometimes this removes a trailing
        # comma that prettier adds back
        run: |
          yarn organize-imports
          git --no-pager diff --exit-code

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Codegen
        run: |
          npm install -g fern-api
          fern generate --local
          yarn workspace fdr run build:prisma
        env:
          FERN_TOKEN: ${{ secrets.FERN_TOKEN }}

      - name: Setup database
        # TODO: re-enable when moving to turbo
        # yarn workspace fdr run docker:local
        run: |
          yarn workspace fdr run test-db
          yarn workspace fdr run test-ete

      - name: Run tests
        run: yarn test --ci

      - name: Ensure no changes to git-tracked files
        run: git --no-pager diff --exit-code

  check-docs-release-is-allowed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Check release blockers
        run: yarn check-docs-release-blockers
