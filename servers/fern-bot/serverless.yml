service: "fern-bot"
frameworkVersion: "3"
plugins:
  - "serverless-esbuild"
  - "serverless-step-functions"
provider:
  name: aws
  runtime: nodejs18.x
  deploymentMethod: direct
  region: "us-east-1"
  # 900 second timeout, e.g. 15 minutes
  timeout: 900
  # 10GB memory
  memorySize: 10240
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
    NODE_OPTIONS: "--enable-source-maps --stack-trace-limit=1000"
    GITHUB_APP_LOGIN_NAME: ${env:GITHUB_APP_LOGIN_NAME, 'fern-api[bot]'}
    GITHUB_APP_LOGIN_ID: ${env:GITHUB_APP_LOGIN_ID, 'placeholder'}
    GITHUB_APP_ID: ${env:GITHUB_APP_ID, 'placeholder'}
    GITHUB_APP_PRIVATE_KEY: ${env:GITHUB_APP_PRIVATE_KEY, 'placeholder'}
    GITHUB_APP_CLIENT_ID: ${env:GITHUB_APP_CLIENT_ID, 'placeholder'}
    GITHUB_APP_CLIENT_SECRET: ${env:GITHUB_APP_CLIENT_SECRET, 'placeholder'}
    GITHUB_APP_WEBHOOK_SECRET: ${env:GITHUB_APP_WEBHOOK_SECRET, 'placeholder'}
    CO_API_KEY: ${env:CO_API_KEY, 'placeholder'}
    REPO_TO_RUN_ON: ${env:REPO_TO_RUN_ON, 'OMIT'}
  # Roles for the lambda functions
  iam:
    role:
      statements:
        - Effect: "Allow"
          Action:
            - s3:ListBucket
          Resource: arn:aws:s3:::fern-bot-${opt:stage}
        - Effect: "Allow"
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource: arn:aws:s3:::fern-bot-${opt:stage}/*

functions:
  # For on-demand invoking update, especially useful for triggering one-off updates
  updateOpenApiSpecs:
    timeout: 900
    memorySize: 10240
    ephemeralStorageSize: 10240
    handler: "src/functions/oas-cron/updateOpenApiSpecs.handler"
    layers:
      - arn:aws:lambda:us-east-1:553035198032:layer:git-lambda2:8

  # The functions needed for the step function
  updateRepoDataset:
    # 900 second timeout, e.g. 15 minutes
    timeout: 900
    # 10GB memory
    memorySize: 10240
    # 10GB storage
    ephemeralStorageSize: 10240
    handler: "src/functions/oas-cron/updateRepoData.handler"
    # Adding a layer to have git available in the lambda
    # https://github.com/lambci/git-lambda-layer
    layers:
      - arn:aws:lambda:us-east-1:553035198032:layer:git-lambda2:8
    environment:
      REPO_DATA_S3_BUCKET: "fern-bot-${opt:stage}"
      REPO_DATA_S3_KEY: "lambdas/repos.csv"

  updateOpenApiSpec:
    timeout: 900
    memorySize: 10240
    ephemeralStorageSize: 10240
    handler: "src/functions/oas-cron/updateOpenApiSpec.handler"
    layers:
      - arn:aws:lambda:us-east-1:553035198032:layer:git-lambda2:8

stepFunctions:
  stateMachines:
    updateSpecs:
      events:
        - schedule:
            rate: cron(0 0 * * ? *)
            enabled: true
      definition:
        StartAt: UpdateRepoDataInS3
        States:
          UpdateRepoDataInS3:
            Type: Task
            Resource:
              Fn::Sub: "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:fern-bot-${opt:stage}-updateRepoDataset"
            Next: UpdateSpecsInRepo
          UpdateSpecsInRepo:
            Type: Map
            ItemReader:
              ReaderConfig:
                InputType: CSV
                CSVHeaderLocation: FIRST_ROW
              Resource: "arn:aws:states:::s3:getObject"
              Parameters:
                Bucket: "fern-bot-${opt:stage}"
                Key: "lambdas/repos.csv"
            ItemProcessor:
              ProcessorConfig:
                Mode: DISTRIBUTED
                ExecutionType: STANDARD
              StartAt: HandleRepo
              States:
                HandleRepo:
                  Type: Task
                  Resource: "arn:aws:states:::lambda:invoke"
                  Parameters:
                    "Payload.$": "$"
                    FunctionName:
                      Fn::GetAtt: [updateOpenApiSpec, Arn]
                  End: true
            End: true

resources:
  Resources:
    BotBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: fern-bot-${opt:stage}

custom:
  esbuild:
    minify: true
    bundle: true
    sourcemap: true
    target: "node18"
    platform: "node"
    concurrency: 10
    packager: pnpm
    external:
      - fern-api
      - fern
    packagerOptions:
      scripts:
        - npm install -g fern-api
